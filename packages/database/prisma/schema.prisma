generator client {
  provider     = "prisma-client-js"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MODULE: USER & AUTHENTICATION
// ============================================================================

enum Role {
  USER
  ADMIN
  SELLER
}

enum Gender {
  MALE
  FEMALE
  OTHER
  UNKNOWN
}

enum DeviceType {
  MOBILE_APP
  WEB
  DESKTOP_APP
}

enum CodeType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  TWO_FACTOR_AUTH
}

model User {
  id       String  @id @default(ulid())
  email    String  @unique
  username String? @unique
  password String

  isActive    Boolean   @default(false)
  isBanned    Boolean   @default(false)
  banReason   String?
  bannedUntil DateTime?

  role Role @default(USER)

  // Relations
  profile           UserProfile?
  shop              Shop?
  sessions          Session[]
  devices           UserDevice[]
  verificationCodes VerificationCode[]
  notifications     Notification[]
  addresses         UserAddress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserProfile {
  id String @id @default(ulid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  displayName String?
  avatar      String?
  background  String?
  phoneNumber String?
  dateOfBirth DateTime?
  gender      Gender    @default(UNKNOWN)

  preferences Json? @default("{}")

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model UserDevice {
  id String @id @default(ulid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  deviceId     String
  type         DeviceType
  isRootDevice Boolean    @default(false)

  deviceName   String
  lastIp       String
  lastActiveAt DateTime @default(now())

  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, deviceId])
}

model Session {
  id String @id @default(ulid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tokenHash String @unique

  userDeviceId String
  userDevice   UserDevice @relation(fields: [userDeviceId], references: [id], onDelete: Cascade)

  userAgent String
  ipAddress String

  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userDeviceId])
  @@index([userId])
}

model VerificationCode {
  id     String @id @default(ulid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type CodeType
  code String

  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId, type])
}

enum AddressType {
  HOME // Nhà riêng (Giao tất cả các ngày)
  OFFICE // Văn phòng (Giao giờ hành chính)
}

model UserAddress {
  id String @id @default(ulid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  recipientName String
  phoneNumber   String

  street   String // Số nhà, tên đường
  ward     String? // Phường/Xã (Để optional vì nước ngoài có thể ko có)
  district String // Quận/Huyện
  city     String // Tỉnh/Thành phố
  country  String  @default("VN")

  isDefault Boolean     @default(false)
  type      AddressType @default(HOME)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// MODULE: NOTIFICATION SYSTEM
// ============================================================================

enum NotificationType {
  // Order Lifecycle
  ORDER_CREATED
  ORDER_CONFIRMED
  ORDER_SHIPPED
  ORDER_DELIVERING
  ORDER_SUCCESS
  ORDER_CANCELLED
  ORDER_RETURN_REQUEST
  ORDER_REFUNDED

  // Social
  RATING_REMINDER
  SHOP_REPLY
  QUESTION_ANSWERED

  // Marketing
  PROMOTION_NEW
  FLASH_SALE_REMINDER
  VOUCHER_RECEIVED
  COIN_RECEIVED
  COIN_EXPIRING

  // System
  WELCOME
  ACCOUNT_SECURITY
  SYSTEM_MAINTENANCE
  POLICY_UPDATE
}

model Notification {
  id     String @id @default(ulid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type NotificationType
  data Json

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // Thêm updatedAt phòng khi user mark as read

  @@index([userId])
  @@index([type])
}

// ============================================================================
// MODULE: SHOP & SELLER
// ============================================================================

model Shop {
  id String @id @default(ulid())

  name        String
  avatar      String
  slug        String  @unique
  description String?

  ownerId String @unique
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// MODULE: PRODUCT CATALOG
// ============================================================================

enum MediaType {
  IMAGE
  VIDEO
}

model Category {
  id        String  @id @default(ulid())
  name      String
  slug      String  @unique
  thumbnail String?

  parentId String?
  parent   Category?  @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryToCategory")

  products ProductCategory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id          String @id @default(ulid())
  name        String
  slug        String @unique
  description String @db.Text

  optionKeys Json @default("[]")

  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  categories    ProductCategory[]
  variants      ProductVariant[]
  productMedias ProductMedia[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductCategory {
  productId  String
  categoryId String

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@id([productId, categoryId])
}

model ProductMedia {
  id    String    @id @default(ulid())
  key   String
  type  MediaType @default(IMAGE)
  alt   String
  order Int       @default(0)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, order])
}

model ProductVariant {
  id String @id @default(ulid())

  sku     String @unique
  barcode String

  price BigInt
  stock Int    @default(0)

  // Dimensions
  weight Float  @default(0)
  length Float?
  width  Float?
  height Float?

  options      Json
  thumbnailURL String

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([sku])
}
